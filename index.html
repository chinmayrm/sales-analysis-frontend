<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Sales Trend Analyzer</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box; margin:0; padding:0}
:root{
  --bg: #f8fafc;
  --panel: #ffffff;
  --muted: #64748b;
  --border: #e2e8f0;
  --brand: #3b82f6;
  --brand-hover: #2563eb;
  --accent: #6366f1;
  --text: #1e293b;
  --success: #10b981;
  --warning: #f59e0b;
  --danger: #ef4444;
  --gradient-start: #3b82f6;
  --gradient-end: #6366f1;
  --card-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.08), 0 5px 10px -5px rgba(0, 0, 0, 0.04);
  --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  --radius: 12px;
}
body{
  margin:0;
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Ubuntu, sans-serif;
  background:var(--bg);
  color:var(--text);
  line-height: 1.6;
  background-image: 
    radial-gradient(circle at 15% 50%, rgba(59, 130, 246, 0.05) 0%, transparent 25%),
    radial-gradient(circle at 85% 30%, rgba(99, 102, 241, 0.05) 0%, transparent 25%);
  background-attachment: fixed;
  min-height: 100vh;
}
.container{
  max-width:1200px;
  margin:32px auto;
  padding:0 20px;
  animation: fadeIn 0.8s ease-out;
}
.header {
  text-align: center;
  margin-bottom: 32px;
  animation: slideDown 0.6s ease-out;
}
h1{
  margin:12px 0 16px;
  font-size:2.5rem;
  font-weight: 700;
  background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  position: relative;
  display: inline-block;
}
h1::after {
  content: '';
  position: absolute;
  bottom: -8px;
  left: 50%;
  transform: translateX(-50%);
  width: 80px;
  height: 4px;
  background: linear-gradient(90deg, var(--gradient-start), var(--gradient-end));
  border-radius: 2px;
}
.subtitle {
  color: var(--muted);
  font-size: 1.1rem;
  max-width: 800px;
  margin: 0 auto;
}
.card{
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:28px;
  margin-bottom:28px;
  box-shadow: var(--card-shadow);
  transition: var(--transition);
  animation: slideUp 0.5s ease-out;
  position: relative;
  overflow: hidden;
}
.card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 4px;
  height: 100%;
  background: linear-gradient(to bottom, var(--gradient-start), var(--gradient-end));
  opacity: 0;
  transition: var(--transition);
}
.card:hover {
  transform: translateY(-5px);
  box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.1);
}
.card:hover::before {
  opacity: 1;
}
.card h2{
  margin:0 0 20px;
  display: flex;
  align-items: center;
  gap: 12px;
  font-weight: 600;
  color: var(--text);
  font-size: 1.5rem;
}
.card h2 i {
  background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  font-size: 1.4rem;
}
.row{
  display:flex;
  gap:14px;
  flex-wrap:wrap;
  margin-bottom: 16px;
}
input[type="file"],input[type="text"]{
  background:var(--bg);
  border:1px solid var(--border);
  color:var(--text);
  padding:14px 16px 14px 48px;
  border-radius:10px;
  transition: var(--transition);
  flex: 1;
  min-width: 160px;
  font-size: 14px;
  box-shadow: 0 1px 2px rgba(0,0,0,0.03);
}
input[type="file"]:hover, input[type="text"]:hover {
  border-color: var(--brand);
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}
input[type="file"]:focus, input[type="text"]:focus {
  outline: none;
  border-color: var(--brand);
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
}
button{
  background:var(--brand);
  color:#fff;
  border:none;
  padding:14px 24px;
  border-radius:10px;
  cursor:pointer;
  transition: var(--transition);
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 14px;
  box-shadow: 0 4px 6px rgba(59, 130, 246, 0.2);
}
button:hover{
  background: var(--brand-hover);
  transform: translateY(-2px);
  box-shadow: 0 6px 12px rgba(59, 130, 246, 0.25);
}
button:active {
  transform: translateY(0);
}
small{
  color:var(--muted);
  font-size: 0.9rem;
  display: block;
  margin-top: 8px;
}
pre{
  white-space:pre-wrap;
  background:var(--bg);
  border:1px solid var(--border);
  padding:18px;
  border-radius:10px;
  max-height:240px;
  overflow:auto;
  transition: var(--transition);
  margin-top: 20px;
  font-size: 13px;
  line-height: 1.5;
}
pre:hover {
  border-color: var(--accent);
  box-shadow: 0 4px 12px rgba(0,0,0,0.05);
}
.grid{
  display:grid;
  grid-template-columns:1fr;
  gap:20px;
}
@media(min-width:900px){
  .grid{grid-template-columns:1fr 1fr}
}
.panel{
  padding:20px;
  border:1px solid var(--border);
  border-radius:var(--radius);
  background:var(--panel);
  transition: var(--transition);
  animation: fadeIn 0.7s ease-out;
  box-shadow: 0 4px 12px rgba(0,0,0,0.03);
}
.panel:hover {
  border-color: var(--accent);
  transform: translateY(-3px);
  box-shadow: 0 8px 20px rgba(0,0,0,0.06);
}
.panel h3 {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 16px;
  font-weight: 600;
  color: var(--text);
}
.panel h3 i {
  color: var(--brand);
}
canvas{
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:10px;
  padding:16px;
  height:360px;
  transition: var(--transition);
  box-shadow: 0 4px 12px rgba(0,0,0,0.03);
}
canvas:hover {
  border-color: var(--accent);
}
.table{
  width:100%;
  border-collapse:collapse;
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:var(--radius);
  overflow:hidden;
  transition: var(--transition);
  box-shadow: 0 4px 12px rgba(0,0,0,0.03);
}
.table:hover {
  border-color: var(--accent);
}
.table th,.table td{
  padding:14px;
  border-bottom:1px solid var(--border);
  text-align:left;
}
.table th {
  background: rgba(59, 130, 246, 0.05);
  font-weight: 600;
  color: var(--text);
}
.table tr:last-child td {
  border-bottom: none;
}
.table tr {
  transition: var(--transition);
}
.table tr:hover {
  background: rgba(59, 130, 246, 0.03);
}
.badge{
  display:inline-block;
  padding:6px 12px;
  border-radius:999px;
  background: rgba(59, 130, 246, 0.1);
  border:1px solid rgba(59, 130, 246, 0.2);
  color: var(--brand);
  font-size:12px;
  font-weight: 600;
  transition: var(--transition);
}
.badge:hover {
  transform: scale(1.05);
  background: rgba(59, 130, 246, 0.15);
}
.stats-container {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
  gap: 16px;
}
.stat-item {
  background: rgba(59, 130, 246, 0.05);
  border-radius: var(--radius);
  padding: 16px;
  text-align: center;
  transition: var(--transition);
  border: 1px solid var(--border);
}
.stat-item:hover {
  background: rgba(59, 130, 246, 0.08);
  transform: translateY(-3px);
  box-shadow: 0 6px 12px rgba(0,0,0,0.05);
}
.stat-value {
  font-size: 1.6rem;
  font-weight: 700;
  margin: 10px 0;
  background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}
.stat-label {
  font-size: 0.85rem;
  color: var(--muted);
  font-weight: 500;
}
.loading {
  position: relative;
  overflow: hidden;
}
.loading::after {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.1), transparent);
  animation: loading 1.5s infinite;
}
@keyframes fadeIn {
  from { opacity: 0; transform: scale(0.98); }
  to { opacity: 1; transform: scale(1); }
}
@keyframes slideUp {
  from { 
    opacity: 0;
    transform: translateY(30px);
  }
  to { 
    opacity: 1;
    transform: translateY(0);
  }
}
@keyframes slideDown {
  from { 
    opacity: 0;
    transform: translateY(-20px);
  }
  to { 
    opacity: 1;
    transform: translateY(0);
  }
}
@keyframes loading {
  0% { left: -100%; }
  100% { left: 100%; }
}
.pulse {
  animation: pulse 2s infinite;
}
@keyframes pulse {
  0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4); }
  70% { box-shadow: 0 0 0 12px rgba(59, 130, 246, 0); }
  100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
}
.advisory-container {
  border-left: 4px solid var(--brand);
  padding-left: 16px;
  background: rgba(59, 130, 246, 0.03);
  border-radius: 8px;
  padding: 16px;
}
.advisory-item {
  margin-bottom: 12px;
  padding: 12px;
  border-radius: 8px;
  background: rgba(59, 130, 246, 0.05);
  transition: var(--transition);
  border-left: 3px solid transparent;
}
.advisory-item:hover {
  background: rgba(59, 130, 246, 0.08);
  transform: translateX(5px);
  border-left-color: var(--brand);
}
.trend-up {
  color: var(--success);
}
.trend-down {
  color: var(--danger);
}
.trend-neutral {
  color: var(--warning);
}
.file-input-container {
  position: relative;
  flex: 1;
}
.file-input-container input[type="file"] {
  width: 100%;
  padding-left: 48px;
  cursor: pointer;
}
.file-input-container i {
  position: absolute;
  left: 16px;
  top: 50%;
  transform: translateY(-50%);
  color: var(--muted);
  z-index: 1;
}
.input-container {
  position: relative;
  flex: 1;
}
.input-container i {
  position: absolute;
  left: 16px;
  top: 50%;
  transform: translateY(-50%);
  color: var(--muted);
  z-index: 1;
}
.input-container input {
  padding-left: 48px;
  width: 100%;
}
.animate-float {
  animation: float 6s ease-in-out infinite;
}
@keyframes float {
  0% { transform: translateY(0px); }
  50% { transform: translateY(-10px); }
  100% { transform: translateY(0px); }
}
.wave {
  animation: wave 8s linear infinite;
}
@keyframes wave {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}
.ripple {
  position: relative;
  overflow: hidden;
}
.ripple:after {
  content: "";
  position: absolute;
  top: 50%;
  left: 50%;
  width: 5px;
  height: 5px;
  background: rgba(255, 255, 255, 0.5);
  opacity: 0;
  border-radius: 100%;
  transform: scale(1, 1) translate(-50%);
  transform-origin: 50% 50%;
}
.ripple:focus:not(:active)::after {
  animation: ripple 1s ease-out;
}
@keyframes ripple {
  0% {
    transform: scale(0, 0);
    opacity: 0.5;
  }
  100% {
    transform: scale(30, 30);
    opacity: 0;
  }
}
.error-panel {
  background: rgba(239, 68, 68, 0.1);
  border: 1px solid rgba(239, 68, 68, 0.2);
  color: var(--danger);
  padding: 16px;
  border-radius: var(--radius);
  margin-top: 16px;
}
.error-panel h4 {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 10px;
}
.success-panel {
  background: rgba(16, 185, 129, 0.1);
  border: 1px solid rgba(16, 185, 129, 0.2);
  color: var(--success);
  padding: 16px;
  border-radius: var(--radius);
  margin-top: 16px;
}
.success-panel h4 {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 10px;
}
</style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1><i class="fas fa-chart-line wave" style="background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; background-size: 200% auto;"></i> Sales Trend Analyzer</h1>
      <p class="subtitle">Upload your sales CSV, train a model, then analyze new data. Required columns: <code>date</code>, <code>price</code>, <code>units</code> (names can be auto-detected or provided below). Optional: <code>product_id</code>/<code>product_name</code>, <code>rating</code>.</p>
    </div>

    <div class="card">
      <h2><i class="fas fa-brain"></i> 1) Train Model</h2>
      <div class="row">
        <div class="file-input-container">
          <i class="fas fa-file-csv"></i>
          <input type="file" id="trainFile" accept=".csv" />
        </div>
        <div class="input-container">
          <i class="fas fa-calendar"></i>
          <input type="text" id="dateCol" placeholder="date_col (optional)"/>
        </div>
        <div class="input-container">
          <i class="fas fa-tag"></i>
          <input type="text" id="priceCol" placeholder="price_col (optional)"/>
        </div>
        <div class="input-container">
          <i class="fas fa-cubes"></i>
          <input type="text" id="unitsCol" placeholder="units_col (optional)"/>
        </div>
        <div class="input-container">
          <i class="fas fa-barcode"></i>
          <input type="text" id="pidCol" placeholder="product_id_col (optional)"/>
        </div>
        <div class="input-container">
          <i class="fas fa-box"></i>
          <input type="text" id="pnameCol" placeholder="product_name_col (optional)"/>
        </div>
        <div class="input-container">
          <i class="fas fa-star"></i>
          <input type="text" id="ratingCol" placeholder="rating_col (optional)"/>
        </div>
        <button id="trainBtn" class="pulse ripple"><i class="fas fa-cog"></i> Train</button>
      </div>
      <small><i class="fas fa-lightbulb"></i> Tip: If you leave columns blank, the backend will try to auto-detect.</small>
      <pre id="trainResult"></pre>
    </div>

    <div class="card">
      <h2><i class="fas fa-search"></i> 2) Analyze New Data</h2>
      <div class="row">
        <div class="file-input-container">
          <i class="fas fa-file-csv"></i>
          <input type="file" id="analyzeFile" accept=".csv" />
        </div>
        <button id="analyzeBtn" class="ripple"><i class="fas fa-chart-bar"></i> Analyze</button>
      </div>
      <div id="advisory" class="panel" style="margin-top:20px"></div>
      <div id="errorMessage" style="display: none;" class="error-panel">
        <h4><i class="fas fa-exclamation-circle"></i> Server Error</h4>
        <p id="errorText"></p>
      </div>
      <div class="grid" style="margin-top:20px">
        <div class="panel">
          <h3><i class="fas fa-money-bill-wave"></i> Revenue Over Time</h3>
          <canvas id="revChart"></canvas>
        </div>
        <div class="panel">
          <h3><i class="fas fa-trophy"></i> Top Products (Revenue)</h3>
          <canvas id="topChart"></canvas>
        </div>
      </div>
      <div class="grid" style="margin-top:20px">
        <div class="panel">
          <h3><i class="fas fa-star"></i> Rating Distribution</h3>
          <canvas id="ratingChart"></canvas>
        </div>
        <div class="panel">
          <h3><i class="fas fa-chart-pie"></i> Key Stats</h3>
          <div id="stats" class="stats-container"></div>
        </div>
      </div>
      <div class="panel" style="margin-top:20px">
        <h3><i class="fas fa-fire"></i> Trending Products (last 7 vs prev 7)</h3>
        <table class="table" id="trendTable">
          <thead><tr><th>Product</th><th>Recent Units</th><th>Prev Units</th><th>Growth</th><th>Recent Revenue</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

<script>
// ==== Configure your deployed backend URL ====
// Try these common Render URL patterns if yours doesn't work
const BACKEND_URLS = ["https://sales-analysis-backend-onqk.onrender.com"];

let CURRENT_BACKEND_URL = BACKEND_URLS[0];

const trainBtn = document.getElementById('trainBtn');
const analyzeBtn = document.getElementById('analyzeBtn');
const trainResult = document.getElementById('trainResult');
const advisoryDiv = document.getElementById('advisory');
const statsDiv = document.getElementById('stats');
const errorDiv = document.getElementById('errorMessage');
const errorText = document.getElementById('errorText');

let revChart = null, topChart = null, ratingChart = null;

function ensureChartDestroyed(chart) { 
  if (chart) {
    chart.destroy();
  }
}

function showError(message) {
  errorText.textContent = message;
  errorDiv.style.display = 'block';
  // Hide after 5 seconds
  setTimeout(() => {
    errorDiv.style.display = 'none';
  }, 5000);
}

function hideError() {
  errorDiv.style.display = 'none';
}

function renderRevenueChart(data){
  const ctx = document.getElementById('revChart').getContext('2d');
  ensureChartDestroyed(revChart);
  const labels = data.dates;
  const datasets = [{
    label: 'Revenue',
    data: data.revenue,
    borderWidth: 3,
    fill: true,
    tension: 0.4,
    borderColor: '#3b82f6',
    backgroundColor: 'rgba(59, 130, 246, 0.1)',
    pointBackgroundColor: '#3b82f6',
    pointBorderColor: '#ffffff',
    pointBorderWidth: 2,
    pointRadius: 4,
    pointHoverRadius: 6
  }];
  
  for (const [name, series] of Object.entries(data.moving_averages || {})) {
    datasets.push({
      label: name.toUpperCase(),
      data: series,
      borderWidth: 2,
      borderDash: [5, 4],
      fill: false,
      tension: 0.2,
      borderColor: name.includes('7') ? '#10b981' : '#f59e0b',
      pointBackgroundColor: name.includes('7') ? '#10b981' : '#f59e0b'
    });
  }
  
  // anomalies
  const pts = labels.map((d,i) => data.anomalies[i] === 1 ? {x: d, y: data.revenue[i]} : null).filter(Boolean);
  if (pts.length){
    datasets.push({
      type:'scatter',
      label:'Anomalies',
      data: pts,
      pointRadius: 6,
      pointBackgroundColor: '#ef4444',
      pointBorderColor: '#ffffff',
      pointBorderWidth: 2,
      pointHoverRadius: 8
    });
  }
  
  // forecast
  if (data.forecast && data.forecast.future_dates){
    datasets.push({
      label:'Forecast',
      data: new Array(labels.length-1).fill(null).concat([data.revenue[data.revenue.length-1]]),
      borderWidth: 2,
      borderDash: [3,3],
      borderColor: '#8b5cf6',
      pointStyle: false
    });
    
    datasets.push({
      label:'Forecast Next',
      data: data.forecast.predictions,
      parsing: false,
      borderWidth: 3,
      fill: false,
      borderColor: '#8b5cf6',
      backgroundColor: 'rgba(139, 92, 246, 0.1)',
      pointStyle: false
    });
  }
  
  revChart = new Chart(ctx, {
    type: 'line',
    data: { labels, datasets },
    options: {
      responsive: true, 
      maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: { 
        legend: { position: 'top', labels: { usePointStyle: true } }, 
        title: { display: true, text: 'Revenue & Moving Averages', color: '#1e293b' } 
      },
      scales: { 
        x: {
          display: true, 
          ticks: { color: '#64748b', autoSkip: true, maxRotation: 0 },
          grid: { color: 'rgba(100, 116, 139, 0.1)' }
        }, 
        y: {
          display: true,
          ticks: { color: '#64748b' },
          grid: { color: 'rgba(100, 116, 139, 0.1)' }
        } 
      },
      animations: {
        tension: {
          duration: 1000,
          easing: 'linear'
        }
      }
    }
  });
}

function renderTopProductsChart(items){
  const ctx = document.getElementById('topChart').getContext('2d');
  ensureChartDestroyed(topChart);
  const labels = items.map(r => r.product_name || r.product_id || '—');
  const values = items.map(r => r.revenue);
  
  // Create gradient for bars
  const gradient = ctx.createLinearGradient(0, 0, 0, 400);
  gradient.addColorStop(0, 'rgba(59, 130, 246, 0.8)');
  gradient.addColorStop(1, 'rgba(59, 130, 246, 0.2)');
  
  topChart = new Chart(ctx, {
    type: 'bar',
    data: { 
      labels, 
      datasets: [{ 
        label: 'Revenue', 
        data: values,
        backgroundColor: gradient,
        borderColor: 'rgba(59, 130, 246, 1)',
        borderWidth: 1,
        borderRadius: 6,
        hoverBackgroundColor: 'rgba(59, 130, 246, 0.7)'
      }]
    },
    options: { 
      responsive: true, 
      maintainAspectRatio: false, 
      indexAxis: 'y',
      scales: {
        x: {
          beginAtZero: true,
          grid: { color: 'rgba(100, 116, 139, 0.1)' },
          ticks: { color: '#64748b' }
        },
        y: {
          grid: { display: false },
          ticks: { color: '#64748b' }
        }
      },
      plugins: {
        legend: { display: false },
        title: { display: true, text: 'Top Products by Revenue', color: '#1e293b' }
      },
      animations: {
        backgroundColor: {
          duration: 1000,
          easing: 'linear'
        }
      }
    }
  });
}

function renderRatingChart(hist){
  const ctx = document.getElementById('ratingChart').getContext('2d');
  ensureChartDestroyed(ratingChart);
  
  if(!hist){ 
    ratingChart = new Chart(ctx, { 
      type: 'bar', 
      data: {
        labels: ['No ratings'], 
        datasets: [{
          label: 'Count', 
          data: [0],
          backgroundColor: 'rgba(100, 116, 139, 0.2)',
          borderColor: 'rgba(100, 116, 139, 0.5)',
          borderWidth: 1
        }]
      },
      options: {
        scales: {
          y: {
            grid: { color: 'rgba(100, 116, 139, 0.1)' },
            ticks: { color: '#64748b' }
          },
          x: {
            grid: { display: false },
            ticks: { color: '#64748b' }
          }
        },
        plugins: {
          legend: { display: false },
          title: { display: true, text: 'Rating Distribution', color: '#1e293b' }
        }
      }
    });
    return;
  }
  
  // Create gradient for rating bars
  const gradient = ctx.createLinearGradient(0, 0, 0, 400);
  gradient.addColorStop(0, 'rgba(245, 158, 11, 0.8)');
  gradient.addColorStop(1, 'rgba(245, 158, 11, 0.2)');
  
  ratingChart = new Chart(ctx, {
    type: 'bar',
    data: { 
      labels: hist.bins, 
      datasets: [{
        label: 'Count', 
        data: hist.counts,
        backgroundColor: gradient,
        borderColor: 'rgba(245, 158, 11, 1)',
        borderWidth: 1,
        borderRadius: 5,
        hoverBackgroundColor: 'rgba(245, 158, 11, 0.7)'
      }] 
    },
    options: { 
      responsive: true, 
      maintainAspectRatio: false, 
      scales: {
        y: {
          beginAtZero: true,
          grid: { color: 'rgba(100, 116, 139, 0.1)' },
          ticks: { color: '#64748b' }
        },
        x: {
          grid: { display: false },
          ticks: { color: '#64748b' }
        }
      },
      plugins: {
        legend: { display: false },
        title: { display: true, text: 'Rating Distribution', color: '#1e293b' }
      }
    }
  });
}

function showStats(stats){
  statsDiv.innerHTML = `
    <div class="stat-item">
      <div class="stat-label">Total Revenue</div>
      <div class="stat-value">₹${stats.total_revenue.toFixed(2)}</div>
    </div>
    <div class="stat-item">
      <div class="stat-label">Total Units</div>
      <div class="stat-value">${stats.total_units.toFixed(0)}</div>
    </div>
    <div class="stat-item">
      <div class="stat-label">Avg Price</div>
      <div class="stat-value">₹${stats.avg_price.toFixed(2)}</div>
    </div>
    <div class="stat-item">
      <div class="stat-label">Days</div>
      <div class="stat-value">${stats.days}</div>
    </div>
    <div class="stat-item">
      <div class="stat-label">Volatility</div>
      <div class="stat-value">${(stats.volatility*100).toFixed(2)}%</div>
    </div>
    <div class="stat-item">
      <div class="stat-label">Trend</div>
      <div class="stat-value">${stats.trend_slope.toExponential(3)}</div>
    </div>
    <div class="stat-item">
      <div class="stat-label">Anomaly Rate</div>
      <div class="stat-value">${(stats.anomaly_rate*100).toFixed(2)}%</div>
    </div>
  `;
}

function renderTrendingTable(rows){
  const tbody = document.querySelector('#trendTable tbody');
  tbody.innerHTML = '';
  rows.forEach(r => {
    const name = r.product_name || r.product_id || '—';
    const growth = (r.growth || 0) * 100;
    const growthClass = growth > 0 ? 'trend-up' : (growth < 0 ? 'trend-down' : 'trend-neutral');
    const growthIcon = growth > 0 ? 'fa-arrow-up' : (growth < 0 ? 'fa-arrow-down' : 'fa-minus');
    
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${name}</td>
      <td>${(r.u_recent||0).toFixed(0)}</td>
      <td>${(r.u_prev||0).toFixed(0)}</td>
      <td class="${growthClass}"><i class="fas ${growthIcon}"></i> ${Math.abs(growth).toFixed(1)}%</td>
      <td>₹${(r.revenue_recent||0).toFixed(2)}</td>
    `;
    tbody.appendChild(tr);
  });
}

trainBtn.addEventListener('click', async () => {
  const file = document.getElementById('trainFile').files[0];
  if(!file){ 
    showError("Please choose a CSV file to train the model.");
    return; 
  }
  
  trainResult.textContent = "Training...";
  trainResult.classList.add('loading');
  hideError();
  
  const fd = new FormData();
  fd.append('file', file);
  const add = (id, key) => {
    const v = document.getElementById(id).value.trim();
    if(v) fd.append(key, v);
  };
  add('dateCol','date_col'); 
  add('priceCol','price_col'); 
  add('unitsCol','units_col');
  add('pidCol','product_id_col'); 
  add('pnameCol','product_name_col'); 
  add('ratingCol','rating_col');
  
  try {
    const res = await fetch(`${CURRENT_BACKEND_URL}/train`, {method: 'POST', body: fd});
    
    if (!res.ok) {
      throw new Error(`Server returned ${res.status}: ${res.statusText}`);
    }
    
    const contentType = res.headers.get('content-type');
    if (!contentType || !contentType.includes('application/json')) {
      const text = await res.text();
      throw new Error(`Expected JSON but got: ${text.substring(0, 100)}...`);
    }
    
    const data = await res.json();
    trainResult.textContent = JSON.stringify(data, null, 2);
    
    // Show success message
    advisoryDiv.innerHTML = `
      <div class="success-panel">
        <h4><i class="fas fa-check-circle"></i> Model Trained Successfully</h4>
        <p>Your model has been trained and is ready for analysis.</p>
      </div>
    `;
    
  } catch(e) {
    showError("Training failed: " + e.message);
    trainResult.textContent = "Error: " + e.message;
  } finally {
    trainResult.classList.remove('loading');
  }
});

analyzeBtn.addEventListener('click', async () => {
  const file = document.getElementById('analyzeFile').files[0];
  if(!file){ 
    showError("Please choose a CSV file to analyze.");
    return; 
  }
  
  advisoryDiv.textContent = "Analyzing...";
  advisoryDiv.classList.add('loading');
  hideError();
  
  const fd = new FormData(); 
  fd.append('file', file);
  
  try {
    const res = await fetch(`${CURRENT_BACKEND_URL}/analyze`, {method: 'POST', body: fd});
    
    if (!res.ok) {
      throw new Error(`Server returned ${res.status}: ${res.statusText}`);
    }
    
    const contentType = res.headers.get('content-type');
    if (!contentType || !contentType.includes('application/json')) {
      const text = await res.text();
      throw new Error(`Expected JSON but got: ${text.substring(0, 100)}...`);
    }
    
    const data = await res.json();
    
    if(data.error){ 
      showError("Analysis error: " + data.error);
      return; 
    }
    
    // Advisory
    advisoryDiv.innerHTML = `
      <div class="advisory-container">
        <h3><i class="fas fa-lightbulb"></i> Advisory Insights</h3>
        ${(data.advisory||[]).map((a,i) => `
          <div class="advisory-item">
            <strong>${i+1}.</strong> ${a}
          </div>
        `).join('')}
      </div>
    `;
    
    // Charts / Tables
    renderRevenueChart(data.chartData);
    renderTopProductsChart(data.topProducts||[]);
    renderRatingChart(data.ratingHistogram||null);
    showStats(data.basic_stats);
    renderTrendingTable(data.trendingProducts||[]);
    
  } catch(e) {
    showError("Analysis failed: " + e.message);
  } finally {
    advisoryDiv.classList.remove('loading');
  }
});

// Test backend connection on load
async function testBackendConnection() {
  try {
    const res = await fetch(`${CURRENT_BACKEND_URL}/health`, {
      method: 'GET',
      headers: {
        'Accept': 'application/json'
      }
    });
    
    if (res.ok) {
      console.log("Backend connection successful");
    } else {
      console.warn("Backend health check failed, trying alternatives...");
      // Try alternative URLs
      for (let i = 1; i < BACKEND_URLS.length; i++) {
        try {
          const altRes = await fetch(`${BACKEND_URLS[i]}/health`);
          if (altRes.ok) {
            CURRENT_BACKEND_URL = BACKEND_URLS[i];
            console.log(`Connected to alternative backend: ${CURRENT_BACKEND_URL}`);
            break;
          }
        } catch (e) {
          console.warn(`Backend ${BACKEND_URLS[i]} failed: ${e.message}`);
        }
      }
    }
  } catch (e) {
    console.error("Backend connection test failed:", e.message);
    showError("Cannot connect to backend server. Please check your internet connection and try again.");
  }
}

// Test connection when page loads
window.addEventListener('load', testBackendConnection);
</script>
</body>
</html>
