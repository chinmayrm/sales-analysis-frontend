<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Sales Trend Analyzer</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
*{box-sizing:border-box}
:root{
  --bg: #0b1220;
  --panel: #111a2b;
  --muted: #8a9bbd;
  --border: #243047;
  --brand: #5d8eff;
  --brand-hover: #4a7df5;
  --accent: #7ba2ff;
  --text: #e6eefb;
  --success: #4ade80;
  --warning: #fbbf24;
  --danger: #f87171;
  --gradient-start: #2563eb;
  --gradient-end: #7c3aed;
  --card-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3);
  --transition: all 0.3s ease;
}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;
  background:var(--bg);
  color:var(--text);
  background-image: 
    radial-gradient(circle at 15% 50%, rgba(28, 47, 82, 0.3) 0%, transparent 25%),
    radial-gradient(circle at 85% 30%, rgba(28, 47, 82, 0.2) 0%, transparent 25%);
  background-attachment: fixed;
}
.container{
  max-width:1080px;
  margin:24px auto;
  padding:0 16px;
  animation: fadeIn 0.8s ease-out;
}
h1{
  margin:8px 0 16px;
  font-size:28px;
  background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  position: relative;
  display: inline-block;
}
h1::after {
  content: '';
  position: absolute;
  bottom: -5px;
  left: 0;
  width: 60%;
  height: 3px;
  background: linear-gradient(90deg, var(--gradient-start), transparent);
  border-radius: 3px;
}
.card{
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:16px;
  padding:24px;
  margin-bottom:24px;
  box-shadow: var(--card-shadow);
  transition: var(--transition);
  animation: slideUp 0.5s ease-out;
}
.card:hover {
  transform: translateY(-3px);
  box-shadow: 0 15px 30px -10px rgba(0, 0, 0, 0.35);
}
.card h2{
  margin:0 0 16px;
  display: flex;
  align-items: center;
  gap: 10px;
}
.card h2 i {
  color: var(--brand);
  font-size: 1.3rem;
}
.row{
  display:flex;
  gap:12px;
  flex-wrap:wrap;
  margin-bottom: 12px;
}
input[type="file"],input[type="text"]{
  background:var(--bg);
  border:1px solid var(--border);
  color:var(--text);
  padding:12px;
  border-radius:10px;
  transition: var(--transition);
  flex: 1;
  min-width: 150px;
}
input[type="file"]:hover, input[type="text"]:hover {
  border-color: var(--brand);
}
input[type="file"]:focus, input[type="text"]:focus {
  outline: none;
  border-color: var(--brand);
  box-shadow: 0 0 0 3px rgba(93, 142, 255, 0.2);
}
button{
  background:var(--brand);
  color:#fff;
  border:none;
  padding:12px 20px;
  border-radius:10px;
  cursor:pointer;
  transition: var(--transition);
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 8px;
}
button:hover{
  background: var(--brand-hover);
  transform: translateY(-2px);
  box-shadow: 0 5px 15px rgba(93, 142, 255, 0.3);
}
button:active {
  transform: translateY(0);
}
small{
  color:var(--muted);
  font-size: 0.85rem;
}
pre{
  white-space:pre-wrap;
  background:var(--bg);
  border:1px solid var(--border);
  padding:16px;
  border-radius:10px;
  max-height:200px;
  overflow:auto;
  transition: var(--transition);
  margin-top: 16px;
}
pre:hover {
  border-color: var(--accent);
}
.grid{
  display:grid;
  grid-template-columns:1fr;
  gap:16px;
}
@media(min-width:900px){
  .grid{grid-template-columns:1fr 1fr}
}
.panel{
  padding:16px;
  border:1px solid var(--border);
  border-radius:12px;
  background:var(--bg);
  transition: var(--transition);
  animation: fadeIn 0.7s ease-out;
}
.panel:hover {
  border-color: var(--accent);
}
.chart-scroll-x {
  width: 100%;
  overflow-x: auto;
  padding-bottom: 8px;
}
.chart-scroll-x canvas {
  min-width: 700px;
  max-width: 2000px;
  width: 1200px;
  height: 360px;
  display: block;
}
canvas{
  background:var(--bg);
  border:1px solid var(--border);
  border-radius:10px;
  padding:12px;
  box-sizing: border-box;
  transition: var(--transition);
  display: block;
}
canvas:hover {
  border-color: var(--accent);
}
.table{
  width:100%;
  border-collapse:collapse;
  background:var(--bg);
  border:1px solid var(--border);
  border-radius:12px;
  overflow:hidden;
  transition: var(--transition);
}
.table:hover {
  border-color: var(--accent);
}
.table th,.table td{
  padding:12px;
  border-bottom:1px solid var(--border);
  text-align:left;
}
.table th {
  background: rgba(36, 48, 71, 0.5);
  font-weight: 600;
}
.table tr:last-child td {
  border-bottom: none;
}
.table tr {
  transition: var(--transition);
}
.table tr:hover {
  background: rgba(93, 142, 255, 0.1);
}
.badge{
  display:inline-block;
  padding:4px 10px;
  border-radius:999px;
  background: linear-gradient(135deg, rgba(36, 48, 71, 0.7), rgba(36, 48, 71, 0.9));
  border:1px solid var(--border);
  color:var(--text);
  font-size:12px;
  font-weight: 600;
  transition: var(--transition);
}
.badge:hover {
  transform: scale(1.05);
  box-shadow: 0 5px 10px rgba(0, 0, 0, 0.2);
}
.stats-container {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
  gap: 12px;
}
.stat-item {
  background: rgba(36, 48, 71, 0.3);
  border-radius: 10px;
  padding: 12px;
  text-align: center;
  transition: var(--transition);
}
.stat-item:hover {
  background: rgba(36, 48, 71, 0.5);
  transform: translateY(-3px);
}
.stat-value {
  font-size: 1.5rem;
  font-weight: 700;
  margin: 8px 0;
  background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}
.stat-label {
  font-size: 0.8rem;
  color: var(--muted);
}
.loading {
  position: relative;
  overflow: hidden;
}
.loading::after {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
  animation: loading 1.5s infinite;
}
@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}
@keyframes slideUp {
  from { 
    opacity: 0;
    transform: translateY(20px);
  }
  to { 
    opacity: 1;
    transform: translateY(0);
  }
}
@keyframes loading {
  0% { left: -100%; }
  100% { left: 100%; }
}
.pulse {
  animation: pulse 2s infinite;
}
@keyframes pulse {
  0% { box-shadow: 0 0 0 0 rgba(93, 142, 255, 0.4); }
  70% { box-shadow: 0 0 0 10px rgba(93, 142, 255, 0); }
  100% { box-shadow: 0 0 0 0 rgba(93, 142, 255, 0); }
}
.advisory-container {
  border-left: 4px solid var(--brand);
  padding-left: 12px;
}
.advisory-item {
  margin-bottom: 8px;
  padding: 8px;
  border-radius: 8px;
  background: rgba(36, 48, 71, 0.3);
  transition: var(--transition);
}
.advisory-item:hover {
  background: rgba(36, 48, 71, 0.5);
  transform: translateX(5px);
}
.trend-up {
  color: var(--success);
}
.trend-down {
  color: var(--danger);
}
.trend-neutral {
  color: var(--warning);
}
.file-input-container {
  position: relative;
  flex: 1;
}
.file-input-container input[type="file"] {
  width: 100%;
  padding-left: 40px;
}
.file-input-container i {
  position: absolute;
  left: 12px;
  top: 50%;
  transform: translateY(-50%);
  color: var(--muted);
}
.input-container {
  position: relative;
  flex: 1;
}
.input-container i {
  position: absolute;
  left: 12px;
  top: 50%;
  transform: translateY(-50%);
  color: var(--muted);
}
.input-container input {
  padding-left: 40px;
  width: 100%;
}
</style>
</head>
<body>
  <div class="container">
    <h1><i class="fas fa-chart-line"></i> Sales Trend Analyzer</h1>
    <p>Upload your sales CSV, train a model, then analyze new data. Required columns: <code>date</code>, <code>price</code>, <code>units</code> (names can be auto-detected or provided below). Optional: <code>product_id</code>/<code>product_name</code>, <code>rating</code>.</p>

    <div class="card">
      <h2><i class="fas fa-brain"></i> 1) Train Model</h2>
      <div class="row">
        <div class="file-input-container">
          <i class="fas fa-file-csv"></i>
          <input type="file" id="trainFile" accept=".csv" />
        </div>
        <div class="input-container">
          <i class="fas fa-calendar"></i>
          <input type="text" id="dateCol" placeholder="date_col (optional)"/>
        </div>
        <div class="input-container">
          <i class="fas fa-tag"></i>
          <input type="text" id="priceCol" placeholder="price_col (optional)"/>
        </div>
        <div class="input-container">
          <i class="fas fa-cubes"></i>
          <input type="text" id="unitsCol" placeholder="units_col (optional)"/>
        </div>
        <div class="input-container">
          <i class="fas fa-barcode"></i>
          <input type="text" id="pidCol" placeholder="product_id_col (optional)"/>
        </div>
        <div class="input-container">
          <i class="fas fa-box"></i>
          <input type="text" id="pnameCol" placeholder="product_name_col (optional)"/>
        </div>
        <div class="input-container">
          <i class="fas fa-star"></i>
          <input type="text" id="ratingCol" placeholder="rating_col (optional)"/>
        </div>
        <button id="trainBtn" class="pulse"><i class="fas fa-cog"></i> Train</button>
      </div>
      <small><i class="fas fa-lightbulb"></i> Tip: If you leave columns blank, the backend will try to auto-detect.</small>
      <pre id="trainResult"></pre>
    </div>

    <div class="card">
      <h2><i class="fas fa-search"></i> 2) Analyze New Data</h2>
      <div class="row">
        <div class="file-input-container">
          <i class="fas fa-file-csv"></i>
          <input type="file" id="analyzeFile" accept=".csv" />
        </div>
        <button id="analyzeBtn"><i class="fas fa-chart-bar"></i> Analyze</button>
      </div>
      <div id="advisory" class="panel" style="margin-top:16px"></div>
      <!-- Revenue Over Time -->
      <div class="grid" style="margin-top:16px">
        <div class="panel">
          <h3><i class="fas fa-money-bill-wave"></i> Revenue Over Time</h3>
          <div class="chart-scroll-x">
            <canvas id="revChart"></canvas>
          </div>
        </div>
      </div>
      <!-- Top Products (Revenue) moved below Revenue Over Time -->
      <div class="grid" style="margin-top:16px">
        <div class="panel">
          <h3><i class="fas fa-trophy"></i> Top Products (Revenue)</h3>
          <div class="chart-scroll-x">
            <canvas id="topChart"></canvas>
          </div>
        </div>
      </div>
      <!-- Rating Distribution, then Key Stats below it -->
      <div class="grid" style="margin-top:16px">
        <div class="panel" style="margin-bottom:0;">
          <h3><i class="fas fa-star"></i> Rating Distribution</h3>
          <div class="chart-scroll-x">
            <canvas id="ratingChart"></canvas>
          </div>
        </div>
      </div>
      <div class="grid" style="margin-top:0;">
        <div class="panel">
          <h3><i class="fas fa-chart-pie"></i> Key Stats</h3>
          <div id="stats" class="stats-container"></div>
        </div>
      </div>
      <div class="panel" style="margin-top:16px">
        <h3><i class="fas fa-fire"></i> Trending Products (last 7 vs prev 7)</h3>
        <table class="table" id="trendTable">
          <thead><tr><th>Product</th><th>Recent Units</th><th>Prev Units</th><th>Growth</th><th>Recent Revenue</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

<script>
// ==== Configure your deployed backend URL ====
const BACKEND_URL = "https://sales-analysis-backend-onqk.onrender.com"; // Updated to Render backend

const trainBtn = document.getElementById('trainBtn');
const analyzeBtn = document.getElementById('analyzeBtn');
const trainResult = document.getElementById('trainResult');
const advisoryDiv = document.getElementById('advisory');
const statsDiv = document.getElementById('stats');

let revChart = null, topChart = null, ratingChart = null;

function ensureChartDestroyed(chart, canvasId) {
  if (chart) {
    chart.destroy();
    // Optionally clear the canvas
    const canvas = document.getElementById(canvasId);
    if (canvas) {
      const ctx = canvas.getContext('2d');
      ctx && ctx.clearRect(0, 0, canvas.width, canvas.height);
    }
  }
}

function renderRevenueChart(data){
  const canvas = document.getElementById('revChart');
  if (!canvas) return;
  ensureChartDestroyed(revChart, 'revChart');
  // Dynamically set canvas width based on data length
  canvas.width = Math.max(700, data.dates.length * 40);
  canvas.height = 360;
  const ctx = canvas.getContext('2d');
  const labels = data.dates;
  const datasets = [{
    label: 'Revenue',
    data: data.revenue,
    borderWidth: 2,
    fill: false,
    tension: 0.2,
    borderColor: '#5d8eff',
    backgroundColor: 'rgba(93, 142, 255, 0.1)'
  }];
  for (const [name, series] of Object.entries(data.moving_averages || {})) {
    datasets.push({
      label: name.toUpperCase(),
      data: series,
      borderWidth: 1,
      borderDash: [5, 4],
      fill: false,
      tension: 0.2,
      borderColor: name.includes('7') ? '#4ade80' : '#fbbf24'
    });
  }
  // anomalies
  const pts = labels.map((d,i)=> data.anomalies[i]===1 ? {x: d, y: data.revenue[i]} : null).filter(Boolean);
  if (pts.length){
    datasets.push({
      type:'scatter',
      label:'Anomalies',
      data:pts,
      pointRadius:5,
      pointBackgroundColor: '#f87171',
      pointBorderColor: '#fff',
      pointBorderWidth: 1
    });
  }
  // forecast
  if (data.forecast && data.forecast.future_dates){
    datasets.push({
      label:'Forecast',
      data: new Array(labels.length-1).fill(null).concat([data.revenue[data.revenue.length-1]]),
      borderWidth:1,
      borderDash:[3,3],
      borderColor: '#7c3aed'
    });
    // simple extension line
    datasets.push({
      label:'Forecast Next',
      data:data.forecast.predictions,
      parsing:false,
      borderWidth:2,
      fill:false,
      borderColor: '#7c3aed'
    });
  }
  revChart = new Chart(ctx, {
    type: 'line',
    data: { labels, datasets },
    options: {
      responsive: false,
      maintainAspectRatio: false,
      interaction:{mode:'index', intersect:false},
      plugins:{ 
        legend:{position:'top'}, 
        title:{display:true, text:'Revenue & MAs'} 
      },
      scales:{ 
        x:{
          display:true, 
          ticks:{autoSkip:true,maxRotation:0},
          grid: { color: 'rgba(255, 255, 255, 0.05)' }
        }, 
        y:{
          display:true,
          grid: { color: 'rgba(255, 255, 255, 0.05)' }
        } 
      }
    }
  });
}

function renderTopProductsChart(items){
  const canvas = document.getElementById('topChart');
  if (!canvas) return;
  ensureChartDestroyed(topChart, 'topChart');
  canvas.width = 900;
  canvas.height = 360;
  const ctx = canvas.getContext('2d');
  const labels = items.map(r => r.product_name || r.product_id || '—');
  const values = items.map(r => r.revenue);
  
  // Create gradient for bars
  const gradient = ctx.createLinearGradient(0, 0, 0, 400);
  gradient.addColorStop(0, 'rgba(93, 142, 255, 0.8)');
  gradient.addColorStop(1, 'rgba(93, 142, 255, 0.2)');
  
  topChart = new Chart(ctx, {
    type:'bar',
    data:{ 
      labels, 
      datasets:[{ 
        label:'Revenue', 
        data: values,
        backgroundColor: gradient,
        borderColor: 'rgba(93, 142, 255, 1)',
        borderWidth: 1,
        borderRadius: 5
      }]
    },
    options:{ 
      responsive: false,
      maintainAspectRatio: false,
      scales:{
        y:{
          beginAtZero:true,
          grid: { color: 'rgba(255, 255, 255, 0.05)' }
        },
        x: {
          grid: { display: false }
        }
      }
    }
  });
}

function renderRatingChart(hist){
  const canvas = document.getElementById('ratingChart');
  if (!canvas) return;
  ensureChartDestroyed(ratingChart, 'ratingChart');
  canvas.width = 700;
  canvas.height = 360;
  const ctx = canvas.getContext('2d');
  if(!hist){ 
    ratingChart = new Chart(ctx, { 
      type:'bar', 
      data:{
        labels:['No ratings'], 
        datasets:[{
          label:'Count', 
          data:[0],
          backgroundColor: 'rgba(136, 136, 136, 0.2)'
        }]
      },
      options: {
        responsive: false,
        maintainAspectRatio: false,
        scales: {
          y: {
            grid: { color: 'rgba(255, 255, 255, 0.05)' }
          },
          x: {
            grid: { display: false }
          }
        }
      }
    });
    return;
  }
  
  // Create gradient for rating bars
  const gradient = ctx.createLinearGradient(0, 0, 0, 400);
  gradient.addColorStop(0, 'rgba(251, 191, 36, 0.8)');
  gradient.addColorStop(1, 'rgba(251, 191, 36, 0.2)');
  
  ratingChart = new Chart(ctx, {
    type:'bar',
    data:{ 
      labels: hist.bins, 
      datasets:[{
        label:'Count', 
        data: hist.counts,
        backgroundColor: gradient,
        borderColor: 'rgba(251, 191, 36, 1)',
        borderWidth: 1,
        borderRadius: 5
      }] 
    },
    options:{ 
      responsive: false,
      maintainAspectRatio: false,
      scales:{
        y:{
          beginAtZero:true,
          grid: { color: 'rgba(255, 255, 255, 0.05)' }
        },
        x: {
          grid: { display: false }
        }
      }
    }
  });
}

function showStats(stats){
  statsDiv.innerHTML = `
    <div class="stat-item">
      <div class="stat-label">Total Revenue</div>
      <div class="stat-value">₹${stats.total_revenue.toFixed(2)}</div>
    </div>
    <div class="stat-item">
      <div class="stat-label">Total Units</div>
      <div class="stat-value">${stats.total_units.toFixed(0)}</div>
    </div>
    <div class="stat-item">
      <div class="stat-label">Avg Price</div>
      <div class="stat-value">₹${stats.avg_price.toFixed(2)}</div>
    </div>
    <div class="stat-item">
      <div class="stat-label">Days</div>
      <div class="stat-value">${stats.days}</div>
    </div>
    <div class="stat-item">
      <div class="stat-label">Volatility</div>
      <div class="stat-value">${(stats.volatility*100).toFixed(2)}%</div>
    </div>
    <div class="stat-item">
      <div class="stat-label">Trend</div>
      <div class="stat-value">${stats.trend_slope.toExponential(3)}</div>
    </div>
    <div class="stat-item">
      <div class="stat-label">Anomaly Rate</div>
      <div class="stat-value">${(stats.anomaly_rate*100).toFixed(2)}%</div>
    </div>
  `;
}

function renderTrendingTable(rows){
  const tbody = document.querySelector('#trendTable tbody');
  tbody.innerHTML = '';
  rows.forEach(r=>{
    const name = r.product_name || r.product_id || '—';
    const growth = (r.growth || 0) * 100;
    const growthClass = growth > 0 ? 'trend-up' : (growth < 0 ? 'trend-down' : 'trend-neutral');
    const growthIcon = growth > 0 ? 'fa-arrow-up' : (growth < 0 ? 'fa-arrow-down' : 'fa-minus');
    
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${name}</td>
      <td>${(r.u_recent||0).toFixed(0)}</td>
      <td>${(r.u_prev||0).toFixed(0)}</td>
      <td class="${growthClass}"><i class="fas ${growthIcon}"></i> ${Math.abs(growth).toFixed(1)}%</td>
      <td>₹${(r.revenue_recent||0).toFixed(2)}</td>
    `;
    tbody.appendChild(tr);
  });
}

trainBtn.addEventListener('click', async ()=>{
  const file = document.getElementById('trainFile').files[0];
  if(!file){ 
    trainResult.textContent = "Please choose a CSV.";
    trainResult.classList.add('loading');
    setTimeout(() => trainResult.classList.remove('loading'), 1500);
    return; 
  }
  
  trainResult.textContent = "Training...";
  trainResult.classList.add('loading');
  
  const fd = new FormData();
  fd.append('file', file);
  const add = (id, key)=>{
    const v = document.getElementById(id).value.trim();
    if(v) fd.append(key, v);
  };
  add('dateCol','date_col'); add('priceCol','price_col'); add('unitsCol','units_col');
  add('pidCol','product_id_col'); add('pnameCol','product_name_col'); add('ratingCol','rating_col');
  
  try{
    const res = await fetch(`${BACKEND_URL}/train`, {method:'POST', body: fd});
    const data = await res.json();
    trainResult.textContent = JSON.stringify(data, null, 2);
    trainResult.classList.remove('loading');
  }catch(e){
    trainResult.textContent = "Error: " + e.message;
    trainResult.classList.remove('loading');
  }
});

analyzeBtn.addEventListener('click', async ()=>{
  const file = document.getElementById('analyzeFile').files[0];
  if(!file){ 
    advisoryDiv.textContent = "Please choose a CSV.";
    advisoryDiv.classList.add('loading');
    setTimeout(() => advisoryDiv.classList.remove('loading'), 1500);
    return; 
  }
  
  advisoryDiv.textContent = "Analyzing...";
  advisoryDiv.classList.add('loading');
  
  const fd = new FormData(); 
  fd.append('file', file);
  
  try{
    const res = await fetch(`${BACKEND_URL}/analyze`, {method:'POST', body: fd});
    const data = await res.json();
    
    if(data.error){ 
      advisoryDiv.textContent = "Error: " + data.error; 
      advisoryDiv.classList.remove('loading');
      return; 
    }
    
    // Advisory
    advisoryDiv.innerHTML = `
      <div class="advisory-container">
        <h3><i class="fas fa-lightbulb"></i> Advisory Insights</h3>
        ${(data.advisory||[]).map((a,i)=> `
          <div class="advisory-item">
            <strong>${i+1}.</strong> ${a}
          </div>
        `).join('')}
      </div>
    `;
    advisoryDiv.classList.remove('loading');
    
    // Charts / Tables
    renderRevenueChart(data.chartData);
    renderTopProductsChart(data.topProducts||[]);
    renderRatingChart(data.ratingHistogram||null);
    showStats(data.basic_stats);
    renderTrendingTable(data.trendingProducts||[]);
    
  }catch(e){
    advisoryDiv.textContent = "Error: " + e.message;
    advisoryDiv.classList.remove('loading');
  }
});
</script>
</body>
</html>
